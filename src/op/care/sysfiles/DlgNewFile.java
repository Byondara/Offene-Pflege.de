/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */

/*
 * DlgNewFile.java
 *
 * Created on 05.04.2011, 17:03:15
 */
package op.care.sysfiles;

import entity.*;
import op.OPDE;
import op.tools.SYSTools;

import java.io.File;
import java.util.Date;

/**
 * @author tloehr
 */
public class DlgNewFile extends javax.swing.JDialog {

    File selectedFile;
    Object[] entities;

    /**
     * Creates new form DlgNewFile
     */
    public DlgNewFile(java.awt.Frame parent) {
        this(parent, null);
    }

    /**
     * Creates new form DlgNewFile
     */
    public DlgNewFile(java.awt.Frame parent, Object entity) {
        this(parent, new Object[]{entity});
    }

    /**
     * Creates new form DlgNewFile
     */
    public DlgNewFile(java.awt.Frame parent, Object[] entities) {
        super(parent, false);
        this.entities = entities;
        initComponents();
        setTitle(SYSTools.getWindowTitle("Neue Datei anh√§ngen"));
        SYSTools.restoreState(this.getClass().getName() + "::cbBeleg", cbBeleg);
        SYSTools.centerOnParent(parent, this);
        setVisible(true);
    }

    /**
     * This method is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        txtFile = new javax.swing.JTextField();
        btnSelectFile = new javax.swing.JButton();
        lblFileExist = new javax.swing.JLabel();
        jScrollPane1 = new javax.swing.JScrollPane();
        txtBemerkung = new javax.swing.JTextPane();
        jLabel1 = new javax.swing.JLabel();
        cbBeleg = new javax.swing.JCheckBox();
        btnOk = new javax.swing.JButton();
        btnCancel = new javax.swing.JButton();

        setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);

        txtFile.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                txtFileActionPerformed(evt);
            }
        });
        txtFile.addFocusListener(new java.awt.event.FocusAdapter() {
            public void focusLost(java.awt.event.FocusEvent evt) {
                txtFileFocusLost(evt);
            }
        });

        btnSelectFile.setIcon(new javax.swing.ImageIcon(getClass().getResource("/artwork/22x22/fileopen.png"))); // NOI18N
        btnSelectFile.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnSelectFileActionPerformed(evt);
            }
        });

        lblFileExist.setIcon(new javax.swing.ImageIcon(getClass().getResource("/artwork/22x22/ballred.png"))); // NOI18N
        lblFileExist.setToolTipText("Datei nicht gefunden.");

        txtBemerkung.addCaretListener(new javax.swing.event.CaretListener() {
            public void caretUpdate(javax.swing.event.CaretEvent evt) {
                txtBemerkungCaretUpdate(evt);
            }
        });
        jScrollPane1.setViewportView(txtBemerkung);

        jLabel1.setText("Bemerkung:");

        cbBeleg.setText("Einbuchungsbeleg drucken");
        cbBeleg.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                cbBelegActionPerformed(evt);
            }
        });

        btnOk.setIcon(new javax.swing.ImageIcon(getClass().getResource("/artwork/22x22/apply.png"))); // NOI18N
        btnOk.setText("Ok");
        btnOk.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnOkActionPerformed(evt);
            }
        });

        btnCancel.setIcon(new javax.swing.ImageIcon(getClass().getResource("/artwork/22x22/cancel.png"))); // NOI18N
        btnCancel.setText("Abbrechen");
        btnCancel.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnCancelActionPerformed(evt);
            }
        });

        org.jdesktop.layout.GroupLayout layout = new org.jdesktop.layout.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
                layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
                        .add(layout.createSequentialGroup()
                                .addContainerGap()
                                .add(layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
                                        .add(cbBeleg)
                                        .add(jLabel1)
                                        .add(jScrollPane1, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, 653, Short.MAX_VALUE)
                                        .add(org.jdesktop.layout.GroupLayout.TRAILING, layout.createSequentialGroup()
                                                .add(txtFile, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, 576, Short.MAX_VALUE)
                                                .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
                                                .add(lblFileExist)
                                                .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
                                                .add(btnSelectFile))
                                        .add(org.jdesktop.layout.GroupLayout.TRAILING, layout.createSequentialGroup()
                                                .add(btnOk)
                                                .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
                                                .add(btnCancel)))
                                .addContainerGap())
        );
        layout.setVerticalGroup(
                layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
                        .add(layout.createSequentialGroup()
                                .addContainerGap()
                                .add(layout.createParallelGroup(org.jdesktop.layout.GroupLayout.TRAILING, false)
                                        .add(txtFile)
                                        .add(lblFileExist, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                                        .add(org.jdesktop.layout.GroupLayout.LEADING, btnSelectFile, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, 38, Short.MAX_VALUE))
                                .add(18, 18, 18)
                                .add(jLabel1)
                                .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
                                .add(jScrollPane1, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, 243, Short.MAX_VALUE)
                                .add(18, 18, 18)
                                .add(cbBeleg)
                                .addPreferredGap(org.jdesktop.layout.LayoutStyle.UNRELATED)
                                .add(layout.createParallelGroup(org.jdesktop.layout.GroupLayout.BASELINE)
                                        .add(btnCancel)
                                        .add(btnOk))
                                .addContainerGap())
        );

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void cbBelegActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_cbBelegActionPerformed
        SYSTools.storeState(this.getClass().getName() + "::cbBeleg", cbBeleg);
    }//GEN-LAST:event_cbBelegActionPerformed

    private void btnOkActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnOkActionPerformed
        SYSFiles sysfile = SYSFilesTools.putFile(selectedFile);
        Object relationEntity;

        OPDE.getEM().getTransaction().begin();
        try {
            for (int i = 0; i < entities.length; i++) {
                if (entities[i] instanceof Bewohner) {
                    relationEntity = new Sysbw2file(txtBemerkung.getText().trim(), sysfile, (Bewohner) entities[i], OPDE.getLogin().getUser());
                } else if (entities[i] instanceof Pflegeberichte) {
                    relationEntity = new Syspb2file(txtBemerkung.getText().trim(), sysfile, (Pflegeberichte) entities[i], OPDE.getLogin().getUser(), new Date());
                } else {
                    relationEntity = null;
                }

                if (relationEntity != null) {
                    OPDE.getEM().persist(relationEntity);

                }
            }
            OPDE.getEM().getTransaction().commit();
        } catch (Exception e) {
            OPDE.getLogger().error(e.getMessage(), e);
            OPDE.getEM().getTransaction().rollback();
        }
        dispose();
    }//GEN-LAST:event_btnOkActionPerformed

    private void setSaveButton() {
        btnOk.setEnabled(!txtBemerkung.getText().trim().equals("") && selectedFile != null && selectedFile.exists());
    }

    private void btnCancelActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnCancelActionPerformed
        dispose();
    }//GEN-LAST:event_btnCancelActionPerformed

    private void btnSelectFileActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnSelectFileActionPerformed
        File[] files = SYSTools.chooseFile(this, false);
        if (files != null && files.length > 0) {
            selectedFile = files[0];
            txtFile.setText(selectedFile.getAbsolutePath());
            lblFileExist.setIcon(new javax.swing.ImageIcon(getClass().getResource("/artwork/22x22/ballgreen.png")));
            lblFileExist.setToolTipText(null);
        } else {
            selectedFile = null;
            txtFile.setText("");
            lblFileExist.setIcon(new javax.swing.ImageIcon(getClass().getResource("/artwork/22x22/ballred.png")));
            lblFileExist.setToolTipText("Datei nicht gefunden.");
        }
        setSaveButton();
    }//GEN-LAST:event_btnSelectFileActionPerformed

    private void txtFileActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_txtFileActionPerformed
        txtBemerkung.requestFocus();
    }//GEN-LAST:event_txtFileActionPerformed

    private void txtFileFocusLost(java.awt.event.FocusEvent evt) {//GEN-FIRST:event_txtFileFocusLost
        selectedFile = new File(txtFile.getText().trim());
        if (selectedFile != null && selectedFile.exists()) {
            lblFileExist.setIcon(new javax.swing.ImageIcon(getClass().getResource("/artwork/22x22/ballgreen.png")));
            lblFileExist.setToolTipText(null);
        } else {
            lblFileExist.setIcon(new javax.swing.ImageIcon(getClass().getResource("/artwork/22x22/ballred.png")));
            lblFileExist.setToolTipText("Datei nicht gefunden.");
        }
        setSaveButton();
    }//GEN-LAST:event_txtFileFocusLost

    private void txtBemerkungCaretUpdate(javax.swing.event.CaretEvent evt) {//GEN-FIRST:event_txtBemerkungCaretUpdate
        setSaveButton();
    }//GEN-LAST:event_txtBemerkungCaretUpdate

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton btnCancel;
    private javax.swing.JButton btnOk;
    private javax.swing.JButton btnSelectFile;
    private javax.swing.JCheckBox cbBeleg;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JLabel lblFileExist;
    private javax.swing.JTextPane txtBemerkung;
    private javax.swing.JTextField txtFile;
    // End of variables declaration//GEN-END:variables
}
