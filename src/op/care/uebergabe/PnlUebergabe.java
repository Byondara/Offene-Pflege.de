/*
 * OffenePflege
 * Copyright (C) 2008 Torsten Löhr
 * This program is free software; you can redistribute it and/or modify it under the terms of the 
 * GNU General Public License V2 as published by the Free Software Foundation
 * 
 * This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even 
 * the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General 
 * Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License along with this program; if not, write to 
 * the Free Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110, USA
 * www.offene-pflege.de
 * ------------------------ 
 * Auf deutsch (freie Übersetzung. Rechtlich gilt die englische Version)
 * Dieses Programm ist freie Software. Sie können es unter den Bedingungen der GNU General Public License, 
 * wie von der Free Software Foundation veröffentlicht, weitergeben und/oder modifizieren, gemäß Version 2 der Lizenz.
 *
 * Die Veröffentlichung dieses Programms erfolgt in der Hoffnung, daß es Ihnen von Nutzen sein wird, aber 
 * OHNE IRGENDEINE GARANTIE, sogar ohne die implizite Garantie der MARKTREIFE oder der VERWENDBARKEIT FÜR EINEN 
 * BESTIMMTEN ZWECK. Details finden Sie in der GNU General Public License.
 *
 * Sie sollten ein Exemplar der GNU General Public License zusammen mit diesem Programm erhalten haben. Falls nicht, 
 * schreiben Sie an die Free Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110, USA.
 * 
 */
package op.care.uebergabe;

import com.toedter.calendar.JDateChooser;
import entity.*;
import entity.system.SYSLoginTools;
import op.OCSec;
import op.OPDE;
import op.care.CleanablePanel;
import op.care.FrmPflege;
import op.tools.HTMLTools;
import op.tools.InternalClassACL;
import op.tools.SYSCalendar;
import op.tools.SYSTools;

import javax.swing.*;
import javax.swing.event.ListSelectionEvent;
import javax.swing.event.ListSelectionListener;
import javax.swing.table.TableColumnModel;
import javax.swing.table.TableModel;
import java.awt.*;
import java.awt.event.ComponentEvent;
import java.text.DateFormat;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Date;
import java.util.Iterator;

/**
 * <I>20.06.2007 - WishID:43</I>
 *
 * @author tloehr
 */
public class PnlUebergabe extends CleanablePanel {

    public static final String internalClassID = "nursingrecords.handover";
    private final int TAB_DATE = 0;
    private final int TAB_SEARCH = 1;
    private ListSelectionListener lsl;
    private boolean initPhase;
    private long selectedTBID = 0;
    private FrmPflege pflege;
    private String classname;
    private OCSec ocs;
    private javax.swing.JFrame parent;
    private JPopupMenu menu;

    /**
     * Creates new form PnlUebergabe
     */
    public PnlUebergabe(FrmPflege pflege) {
        this.pflege = pflege;
        this.initPhase = true;
        this.classname = this.getClass().getName();
        this.parent = pflege;
        ocs = OPDE.getOCSec();
        initComponents();

        EinrichtungenTools.setComboBox(cmbEinrichtung);
        jdcDatum.setDate(SYSCalendar.today_date());

        this.initPhase = false;
        reloadTable();
    }

    public FrmPflege getPflege() {
        return pflege;
    }

    @Override
    public void change2Bewohner(Bewohner bewohner) {
        //To change body of implemented methods use File | Settings | File Templates.
    }

    /**
     * This method is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        bgSuche = new javax.swing.ButtonGroup();
        bgSortierung = new javax.swing.ButtonGroup();
        jToolBar1 = new javax.swing.JToolBar();
        btnNew = new javax.swing.JButton();
        btnConfirmAll = new javax.swing.JButton();
        btnLogout = new javax.swing.JButton();
        lblFrage = new javax.swing.JLabel();
        jspUebergabe = new javax.swing.JScrollPane();
        tblUebergabe = new javax.swing.JTable();
        pnlFilter = new javax.swing.JTabbedPane();
        jPanel4 = new javax.swing.JPanel();
        jLabel2 = new javax.swing.JLabel();
        btnToday = new javax.swing.JButton();
        btnBack = new javax.swing.JButton();
        btnLastLogin = new javax.swing.JButton();
        cmbEinrichtung = new javax.swing.JComboBox();
        jdcDatum = new com.toedter.calendar.JDateChooser();
        jPanel5 = new javax.swing.JPanel();
        txtSuche1 = new javax.swing.JTextField();
        btnSearch = new javax.swing.JButton();

        jToolBar1.setFloatable(false);

        btnNew.setIcon(new javax.swing.ImageIcon(getClass().getResource("/artwork/22x22/filenew.png"))); // NOI18N
        btnNew.setText("Neue Eingabe");
        btnNew.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnNewActionPerformed(evt);
            }
        });
        jToolBar1.add(btnNew);

        btnConfirmAll.setIcon(new javax.swing.ImageIcon(getClass().getResource("/artwork/22x22/apply-all.png"))); // NOI18N
        btnConfirmAll.setText("Alle Bestätigen");
        btnConfirmAll.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnConfirmAllActionPerformed(evt);
            }
        });
        jToolBar1.add(btnConfirmAll);

        btnLogout.setIcon(new javax.swing.ImageIcon(getClass().getResource("/artwork/22x22/lock.png"))); // NOI18N
        btnLogout.setText("Abmelden");
        btnLogout.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnLogoutActionPerformed(evt);
            }
        });
        jToolBar1.add(btnLogout);

        lblFrage.setFont(new java.awt.Font("Dialog", 1, 18));
        lblFrage.setText("Übergabeprotokoll");

        jspUebergabe.addComponentListener(new java.awt.event.ComponentAdapter() {
            public void componentResized(java.awt.event.ComponentEvent evt) {
                jspUebergabeComponentResized(evt);
            }
        });

        tblUebergabe.setModel(new javax.swing.table.DefaultTableModel(
                new Object[][]{
                        {null, null, null, null},
                        {null, null, null, null},
                        {null, null, null, null},
                        {null, null, null, null}
                },
                new String[]{
                        "Title 1", "Title 2", "Title 3", "Title 4"
                }
        ));
        tblUebergabe.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mousePressed(java.awt.event.MouseEvent evt) {
                tblUebergabeMousePressed(evt);
            }
        });
        tblUebergabe.addPropertyChangeListener(new java.beans.PropertyChangeListener() {
            public void propertyChange(java.beans.PropertyChangeEvent evt) {
                tblUebergabePropertyChange(evt);
            }
        });
        jspUebergabe.setViewportView(tblUebergabe);

        pnlFilter.addChangeListener(new javax.swing.event.ChangeListener() {
            public void stateChanged(javax.swing.event.ChangeEvent evt) {
                pnlFilterStateChanged(evt);
            }
        });

        jLabel2.setText("Berichte anzeigen vom:");

        btnToday.setText("Heute");
        btnToday.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnTodayActionPerformed(evt);
            }
        });

        btnBack.setText("einen Tag zurück");
        btnBack.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnBackActionPerformed(evt);
            }
        });

        btnLastLogin.setText("letzte Abmeldung");
        btnLastLogin.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnLastLoginActionPerformed(evt);
            }
        });

        cmbEinrichtung.setModel(new javax.swing.DefaultComboBoxModel(new String[]{"Item 1", "Item 2", "Item 3", "Item 4"}));
        cmbEinrichtung.addItemListener(new java.awt.event.ItemListener() {
            public void itemStateChanged(java.awt.event.ItemEvent evt) {
                cmbEinrichtungItemStateChanged(evt);
            }
        });

        jdcDatum.addPropertyChangeListener(new java.beans.PropertyChangeListener() {
            public void propertyChange(java.beans.PropertyChangeEvent evt) {
                jdcDatumPropertyChange(evt);
            }
        });

        javax.swing.GroupLayout jPanel4Layout = new javax.swing.GroupLayout(jPanel4);
        jPanel4.setLayout(jPanel4Layout);
        jPanel4Layout.setHorizontalGroup(
                jPanel4Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                        .addGroup(jPanel4Layout.createSequentialGroup()
                                .addContainerGap()
                                .addComponent(jLabel2)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                .addComponent(jdcDatum, javax.swing.GroupLayout.PREFERRED_SIZE, 161, javax.swing.GroupLayout.PREFERRED_SIZE)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                .addComponent(btnBack)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                .addComponent(btnLastLogin)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                .addComponent(btnToday)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                .addComponent(cmbEinrichtung, 0, 137, Short.MAX_VALUE)
                                .addContainerGap())
        );
        jPanel4Layout.setVerticalGroup(
                jPanel4Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                        .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, jPanel4Layout.createSequentialGroup()
                                .addContainerGap()
                                .addGroup(jPanel4Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                                        .addComponent(jLabel2, javax.swing.GroupLayout.DEFAULT_SIZE, 31, Short.MAX_VALUE)
                                        .addComponent(jdcDatum, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                                        .addGroup(jPanel4Layout.createSequentialGroup()
                                                .addComponent(btnBack, javax.swing.GroupLayout.PREFERRED_SIZE, 27, javax.swing.GroupLayout.PREFERRED_SIZE)
                                                .addGap(2, 2, 2))
                                        .addGroup(jPanel4Layout.createSequentialGroup()
                                                .addComponent(btnLastLogin)
                                                .addGap(1, 1, 1))
                                        .addComponent(btnToday, javax.swing.GroupLayout.PREFERRED_SIZE, 31, javax.swing.GroupLayout.PREFERRED_SIZE)
                                        .addGroup(jPanel4Layout.createSequentialGroup()
                                                .addComponent(cmbEinrichtung, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                                                .addGap(3, 3, 3)))
                                .addGap(62, 62, 62))
        );

        jPanel4Layout.linkSize(javax.swing.SwingConstants.VERTICAL, new java.awt.Component[]{cmbEinrichtung, jdcDatum});

        pnlFilter.addTab("Zeiraum", jPanel4);

        txtSuche1.setFont(new java.awt.Font("Lucida Grande", 0, 18));
        txtSuche1.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                txtSuche1ActionPerformed(evt);
            }
        });

        btnSearch.setText("Los gehts");
        btnSearch.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnSearchActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout jPanel5Layout = new javax.swing.GroupLayout(jPanel5);
        jPanel5.setLayout(jPanel5Layout);
        jPanel5Layout.setHorizontalGroup(
                jPanel5Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                        .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, jPanel5Layout.createSequentialGroup()
                                .addContainerGap()
                                .addComponent(txtSuche1, javax.swing.GroupLayout.DEFAULT_SIZE, 752, Short.MAX_VALUE)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                .addComponent(btnSearch)
                                .addContainerGap())
        );
        jPanel5Layout.setVerticalGroup(
                jPanel5Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                        .addGroup(jPanel5Layout.createSequentialGroup()
                                .addContainerGap()
                                .addGroup(jPanel5Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                                        .addGroup(jPanel5Layout.createSequentialGroup()
                                                .addComponent(txtSuche1, javax.swing.GroupLayout.DEFAULT_SIZE, 38, Short.MAX_VALUE)
                                                .addGap(3, 3, 3))
                                        .addComponent(btnSearch, javax.swing.GroupLayout.PREFERRED_SIZE, 38, javax.swing.GroupLayout.PREFERRED_SIZE))
                                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );

        jPanel5Layout.linkSize(javax.swing.SwingConstants.VERTICAL, new java.awt.Component[]{btnSearch, txtSuche1});

        pnlFilter.addTab("Suchbegriff", jPanel5);

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(this);
        this.setLayout(layout);
        layout.setHorizontalGroup(
                layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                        .addComponent(jToolBar1, javax.swing.GroupLayout.DEFAULT_SIZE, 964, Short.MAX_VALUE)
                        .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup()
                                .addContainerGap()
                                .addComponent(lblFrage, javax.swing.GroupLayout.DEFAULT_SIZE, 924, Short.MAX_VALUE)
                                .addContainerGap())
                        .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup()
                                .addContainerGap()
                                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                                        .addComponent(jspUebergabe, javax.swing.GroupLayout.Alignment.LEADING, javax.swing.GroupLayout.DEFAULT_SIZE, 924, Short.MAX_VALUE)
                                        .addComponent(pnlFilter, javax.swing.GroupLayout.Alignment.LEADING, javax.swing.GroupLayout.DEFAULT_SIZE, 924, Short.MAX_VALUE))
                                .addContainerGap())
        );
        layout.setVerticalGroup(
                layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                        .addGroup(layout.createSequentialGroup()
                                .addComponent(jToolBar1, javax.swing.GroupLayout.PREFERRED_SIZE, 38, javax.swing.GroupLayout.PREFERRED_SIZE)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                .addComponent(lblFrage)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                                .addComponent(pnlFilter, javax.swing.GroupLayout.PREFERRED_SIZE, 112, javax.swing.GroupLayout.PREFERRED_SIZE)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                .addComponent(jspUebergabe, javax.swing.GroupLayout.DEFAULT_SIZE, 310, Short.MAX_VALUE)
                                .addContainerGap())
        );
    }// </editor-fold>//GEN-END:initComponents

    private void tblUebergabePropertyChange(java.beans.PropertyChangeEvent evt) {//GEN-FIRST:event_tblUebergabePropertyChange
    }//GEN-LAST:event_tblUebergabePropertyChange

    private void btnNewActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnNewActionPerformed
        btnNew.setEnabled(false);
        new DlgBericht(this, (Einrichtungen) cmbEinrichtung.getSelectedItem(), jdcDatum.getDate());
    }//GEN-LAST:event_btnNewActionPerformed

    private void btnLogoutActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnLogoutActionPerformed
        OPDE.ocmain.lockOC();
    }//GEN-LAST:event_btnLogoutActionPerformed

    private void btnConfirmAllActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnConfirmAllActionPerformed
        TMUebergabe tm = (TMUebergabe) tblUebergabe.getModel();
        if (tm.getRowCount() > 0) {
            ConfirmWorker work = new ConfirmWorker(tm.getBerichte());
            btnConfirmAll.setEnabled(false);
            work.start();
        }
    }//GEN-LAST:event_btnConfirmAllActionPerformed

    /**
     * Innere Hilfsklasse. Mit ihrer Hilfe erscheint ein kleines Fenster mit einem Progressbar,
     * während die Bestätigungsprozedur abläuft. Dieses Fenster kann man abbrechen,
     * dann werden auch die bisherigen Bestätigung zurück gerollt.
     */
    class ConfirmWorker extends Thread {

        private ArrayList berichte;
        private ProgressMonitor pm;

        public ConfirmWorker(ArrayList berichte) {
            super();
            this.berichte = berichte;
            pm = new ProgressMonitor(pflege, "Bitte warten", "Protokoll wird bestätigt.", 0, berichte.size());
            pm.setMillisToDecideToPopup(0);
            pm.setMillisToPopup(0);
        }

        public void run() {
            confirm();
        }

        private void setProgressFromWorker(final int progress) {
            try {
                javax.swing.SwingUtilities.invokeAndWait(new Runnable() {

                    public void run() {
                        pm.setProgress(progress);
                    }
                });
            } catch (Exception e) {
                // oh well.
            }
        }

        private void confirm() {
            int max = berichte.size();

            OPDE.getEM().getTransaction().begin();

            try {
                for (int row = 0; row < max; row++) {
                    setProgressFromWorker(row);
                    Object[] bericht = (Object[]) berichte.get(row);
                    if (((Long) bericht[TMUebergabe.LIST_ACKNOWLEDGED]).longValue() == 0) { // aktueller User hat diesen Bericht noch nicht bestätigt.
                        if (bericht[TMUebergabe.LIST_BERICHT] instanceof Uebergabebuch) {
                            Uebergabebuch uebergabe = (Uebergabebuch) bericht[TMUebergabe.LIST_BERICHT];
                            uebergabe.getUsersAcknowledged().add(new Uebergabe2User(uebergabe, OPDE.getLogin().getUser()));
                            OPDE.getEM().merge(uebergabe);
                        } else {
                            Pflegeberichte pflegebericht = (Pflegeberichte) bericht[TMUebergabe.LIST_BERICHT];
                            pflegebericht.getUsersAcknowledged().add(new PB2User(pflegebericht, OPDE.getLogin().getUser()));
                            OPDE.getEM().merge(pflegebericht);
                        }
                    }
                    if (pm.isCanceled()) {
                        throw new Exception("Bestätigung abgebrochen.");
                    }
                }
                OPDE.getEM().getTransaction().commit();
            } catch (Exception e) {
                OPDE.getEM().getTransaction().rollback();
            }
            btnConfirmAll.setEnabled(true);
            reloadTable();
            pm.setProgress(max);
            //pm.close();
            try {
                Thread.currentThread().sleep(500);
            } catch (Exception e) {
            }
        }
    }

    private void jspUebergabeComponentResized(java.awt.event.ComponentEvent evt) {//GEN-FIRST:event_jspUebergabeComponentResized
        JScrollPane jsp = (JScrollPane) evt.getComponent();
        Dimension dim = jsp.getSize();
        // Größe der Text Spalten im DFN ändern.
        // Summe der fixen Spalten  = 175 + ein bisschen
        int textWidth = dim.width - 200 - 200 - 50;
        TableColumnModel tcm1 = tblUebergabe.getColumnModel();
        if (tcm1.getColumnCount() < 3) {
            return;
        }

        tcm1.getColumn(TMUebergabe.COL_PIT).setPreferredWidth(200);
        tcm1.getColumn(TMUebergabe.COL_INFO).setPreferredWidth(200);
        tcm1.getColumn(TMUebergabe.COL_HTML).setPreferredWidth(textWidth);
        tcm1.getColumn(TMUebergabe.COL_ACKN).setPreferredWidth(50);

        tcm1.getColumn(TMUebergabe.COL_PIT).setHeaderValue("Datum");
        tcm1.getColumn(TMUebergabe.COL_INFO).setHeaderValue("Info");
        tcm1.getColumn(TMUebergabe.COL_HTML).setHeaderValue("Bericht");
        tcm1.getColumn(TMUebergabe.COL_ACKN).setHeaderValue("Gesehen");

    }//GEN-LAST:event_jspUebergabeComponentResized

    private void cmbEinrichtungItemStateChanged(java.awt.event.ItemEvent evt) {//GEN-FIRST:event_cmbEinrichtungItemStateChanged
        if (initPhase) {
            return;
        }
        reloadTable();
    }//GEN-LAST:event_cmbEinrichtungItemStateChanged

    private void jdcDatumPropertyChange(java.beans.PropertyChangeEvent evt) {//GEN-FIRST:event_jdcDatumPropertyChange
        if (initPhase) {
            return;
        }
        if (!evt.getPropertyName().equals("date")) {
            return;
        }
        SYSCalendar.checkJDC((JDateChooser) evt.getSource());
        reloadTable();
    }//GEN-LAST:event_jdcDatumPropertyChange

    private void tblUebergabeMousePressed(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_tblUebergabeMousePressed
        Point p = evt.getPoint();
        ListSelectionModel lsm = tblUebergabe.getSelectionModel();

        int row = tblUebergabe.rowAtPoint(p);
        lsm.setSelectionInterval(row, row);

        Object bericht = tblUebergabe.getModel().getValueAt(lsm.getLeadSelectionIndex(), TMUebergabe.COL_BERICHT);

        if (evt.isPopupTrigger()) {

//            JMenuItem itemPopupPrint = new JMenuItem("Markierte Berichte drucken");
//            itemPopupPrint.addActionListener(new java.awt.event.ActionListener() {
//
//                public void actionPerformed(java.awt.event.ActionEvent evt) {
//                    int[] sel = tblTB.getSelectedRows();
//                    printBericht(sel);
//                }
//            });
//            menu.add(itemPopupPrint);

//            itemPopupEdit.setEnabled(OPDE.internalClasses.userHasAccessLevelForThisClass(internalClassID, InternalClassACL.UPDATE));

            menu = new JPopupMenu();
            if (OPDE.getAppInfo().userHasAccessLevelForThisClass(internalClassID, InternalClassACL.USER1)) {
                DateFormat df = DateFormat.getDateTimeInstance();
                JMenu menuListAck = new JMenu("Bestätigungen");
                if (bericht instanceof Uebergabebuch) {
                    if (((Uebergabebuch) bericht).getUsersAcknowledged().isEmpty()) {
                        menuListAck.add(new JMenuItem("bisher keine Bestätigungen"));
                    } else {
                        Iterator<Uebergabe2User> it = ((Uebergabebuch) bericht).getUsersAcknowledged().iterator();
                        while (it.hasNext()) {
                            Uebergabe2User u2u = it.next();
                            menuListAck.add(new JMenuItem(u2u.getUser().getNameUndVorname() + " <b>[" + df.format(u2u.getPit()) + "]</b>"));
                        }
                    }
                } else {
                    if (((Pflegeberichte) bericht).getUsersAcknowledged().isEmpty()) {
                        menuListAck.add(new JMenuItem("bisher keine Bestätigungen"));
                    } else {
                        ArrayList<PB2User> usersackn = new ArrayList<PB2User>(((Pflegeberichte) bericht).getUsersAcknowledged());
                        Collections.sort(usersackn);
                        Iterator<PB2User> it = usersackn.iterator();
                        while (it.hasNext()) {
                            PB2User p2u = it.next();
                            menuListAck.add(new JMenuItem(HTMLTools.toHTML(p2u.getUser().getNameUndVorname() + " <b>[" + df.format(p2u.getPit()) + "]</b>")));
                        }
                    }
                }
                menu.add(menuListAck);
            }

            menu.show(evt.getComponent(), (int) p.getX(), (int) p.getY());
        }
    }//GEN-LAST:event_tblUebergabeMousePressed

    private void btnTodayActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnTodayActionPerformed
        jdcDatum.setDate(new Date());
    }//GEN-LAST:event_btnTodayActionPerformed

    private void btnBackActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnBackActionPerformed
        jdcDatum.setDate(SYSCalendar.addDate(jdcDatum.getDate(), -1));
    }//GEN-LAST:event_btnBackActionPerformed

    private void btnLastLoginActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnLastLoginActionPerformed
        // Der Tag der letzten Abmeldung
        jdcDatum.setDate(SYSLoginTools.getPreviousLogin(OPDE.getLogin()).getLogout());

        // Hier muss erst die Infratstruktur für die neue anmeldung rein.
        // Wir brauchen eine HOSTS tabelle, die dann auf Logins verweist.
        // die logins wiederum müssen die internal classes auflisten, die gerade offen sind
        // der Proof of Life muss sich auf den Host beziehen.
        // die collision domains müssen mit in die internalClasses mit rein.
        // die Host kennung kann durch die localproperties überschrieben werden.
        // die Zuordnung welche Maschine welche Station anzeigen soll, findet über die Hosts statt.

    }//GEN-LAST:event_btnLastLoginActionPerformed

    private void txtSuche1ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_txtSuche1ActionPerformed
//        if (!txtSuche.equals("")) {
//            reloadTable();
//        }
    }//GEN-LAST:event_txtSuche1ActionPerformed

    private void btnSearchActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnSearchActionPerformed
//        if (!txtSuche.equals("")) {
//            reloadTable();
//        }
    }//GEN-LAST:event_btnSearchActionPerformed

    private void pnlFilterStateChanged(javax.swing.event.ChangeEvent evt) {//GEN-FIRST:event_pnlFilterStateChanged
        if (pnlFilter.getSelectedIndex() == TAB_SEARCH) {
            //txtSuche.requestFocus();


        }
    }//GEN-LAST:event_pnlFilterStateChanged

    public void cleanup() {
        jdcDatum.cleanup();
        SYSTools.unregisterListeners(this);
    }

    public void reloadTable() {
        btnNew.setEnabled(true);
        // Tagesbericht Liste aktualisieren
        ListSelectionModel lsm = tblUebergabe.getSelectionModel();
        if (lsl != null) {
            lsm.removeListSelectionListener(lsl);

        }
        lsl = new HandleSelections();

        int sort = TMUebergabe.SORT_NAME;
//        if (rbSortUhrzeit.isSelected()) {
//            sort = TMUebergabe.SORT_UHRZEIT;
//        }
        if (pnlFilter.getSelectedIndex() == TAB_DATE) {
            tblUebergabe.setModel(new TMUebergabe(jdcDatum.getDate(), (Einrichtungen) cmbEinrichtung.getSelectedItem()));
        } else {
//            if (!txtSuche.getText().equals("")) {
//                tblUebergabe.setModel(new TMUebergabe(le.getData(), txtSuche.getText(), sort));
//            }
        }

        // Sonst wird der Listenaufbau sehr langsam.
        // tblTB.setAutoResizeMode(JTable.AUTO_RESIZE_OFF);
        tblUebergabe.setSelectionMode(javax.swing.ListSelectionModel.SINGLE_SELECTION);
        lsm.addListSelectionListener(lsl);

        jspUebergabe.dispatchEvent(new ComponentEvent(jspUebergabe, ComponentEvent.COMPONENT_RESIZED));

        tblUebergabe.getColumnModel().getColumn(TMUebergabe.COL_PIT).setCellRenderer(new RNDUbergabe());
        tblUebergabe.getColumnModel().getColumn(TMUebergabe.COL_INFO).setCellRenderer(new RNDUbergabe());
        tblUebergabe.getColumnModel().getColumn(TMUebergabe.COL_HTML).setCellRenderer(new RNDUbergabe());
        tblUebergabe.getColumnModel().getColumn(TMUebergabe.COL_ACKN).setCellRenderer(new RNDUbergabe());

    }

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.ButtonGroup bgSortierung;
    private javax.swing.ButtonGroup bgSuche;
    private javax.swing.JButton btnBack;
    private javax.swing.JButton btnConfirmAll;
    private javax.swing.JButton btnLastLogin;
    private javax.swing.JButton btnLogout;
    private javax.swing.JButton btnNew;
    private javax.swing.JButton btnSearch;
    private javax.swing.JButton btnToday;
    private javax.swing.JComboBox cmbEinrichtung;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JPanel jPanel4;
    private javax.swing.JPanel jPanel5;
    private javax.swing.JToolBar jToolBar1;
    private com.toedter.calendar.JDateChooser jdcDatum;
    private javax.swing.JScrollPane jspUebergabe;
    private javax.swing.JLabel lblFrage;
    private javax.swing.JTabbedPane pnlFilter;
    private javax.swing.JTable tblUebergabe;
    private javax.swing.JTextField txtSuche1;
    // End of variables declaration//GEN-END:variables

    class HandleSelections implements ListSelectionListener {

        public void valueChanged(ListSelectionEvent lse) {
            // Erst reagieren wenn der Auswahl-Vorgang abgeschlossen ist.
            TableModel tm = tblUebergabe.getModel();
            if (!lse.getValueIsAdjusting()) {
                DefaultListSelectionModel lsm = (DefaultListSelectionModel) lse.getSource();
                btnConfirmAll.setEnabled(true);
//                selectedTBID = ((Long) tm.getValueAt(lsm.getLeadSelectionIndex(), TMUebergabe.COL_TBID)).longValue();
//                long qsuid = ((Long) tm.getValueAt(lsm.getLeadSelectionIndex(), TMUebergabe.COL_QSUID)).longValue();
//                btnConfirm.setEnabled(!lsm.isSelectionEmpty() && qsuid == 0);
                //btnInfo.setEnabled(ocs.mayEnabled(classname, "btnInfo", !lsm.isSelectionEmpty()));


            }
        }
    }
//    private boolean mayEnabled(String sjc, boolean desiredState){
//        HashMap hm = new HashMap();
//        
//        if (OPDE.ocgroups.containsKey("admin") || OPDE.ocgroups.containsKey("pdl")) {
//            hm.put(sjc+".enabled",new Boolean(true));
//        } else {
//            hm.put(sjc+".enabled",new Boolean(false));
//        }
//        
//        // Ohne Eintrag gilt die Erlaubnis als erteilt (!containskey)
//        boolean access = !hm.containsKey(sjc+".enabled") || ((Boolean) hm.get(sjc+".enabled")).booleanValue();
//        
//        return (desiredState && access);
//    }
}
